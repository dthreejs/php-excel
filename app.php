<?php
	/*
	 *  Hamilton Nieri
	 *  Generates Excel (.xlsx)
	 *  1/18/2016
	 *
	 */ 

	$json = '{
		"date_created" : "1/23/2016",
		"date_revised" : "1/23/2016",
		"qty" : "10",
		"product_name" : "Toy RC Bobcat 1:10",
		"product_manager" : "Rocky-ONE",
		"age_grading" : "8+",
		"acc_executive" : "executive",
		"maker" : "Not Booked",
		"factory" : "ZK",
		"main_thumb" : "sample.png",
		"ticked_pckgs" : [
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			}
		],
		"product_req" : "US Patent 6,338,289 B1 molded on product",
		"power_source" : "Car: 12.8V Li-ion",
		"ac_dc_adapter" : "NA",
		"voltage" : "12.8",
		"mortor_type" : "TBD",
		"lumens" : "NA",
		"ansi_distance" : "NA",
		"additional_spec" : "WERCS registration for all items with batteries",
		"frequency" : "909.06/913.06/917.06/921.06 MHz",
		"working_current" : "TBD",
		"standby_current" : "TBD",
		"battery_life" : "TBD",
		"ipx4" : "NA",
		"water_resistence" : "NA",
		"infrared" : "NA",
		"bluetooth" : "NA",
		"usb" : "NA",
		"software_included" : "NA",
		"ansi_fl1" : "NA",
		"org_pckg" : "4C Window Box",
		"org_dimensions" : "24 x 13.5 x 12.25",
		"org_colors" : "4C",
		"org_material" : "350g CCNB+140g medium+150g kraft or white",
		"new_pckg" : "Same Comps",
		"new_dimensions" : "Same Comps",
		"new_colors" : "Same Comps",
		"new_material" : "Same Comps",
		"master_cspec" : "NA",
		"master_dimensions" : "NA",
		"master_nweight" : "1080g/2.4lb",
		"master_gweight" : "2375g/5.3lb",
		"case_pack" : "4",
		"country_dest" : "NA",
		"unticked_pckgs" : [
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			},
			{
				"photo" : "sample.png",
				"comp" : "Operation: Turn left/right; forward/reverse; 4-band auto pairing<br>Frequency: 909.06/913.06/917.06/921.06 MHz<br>Auto Shut off after 30mins of inactivity.<br><br>Remote control distance: 30meters",
				"changes" : "Quote options:<br>1. Same as original &nbsp;: with removeable &nbsp;12.8v Lithium Ion Battery and &nbsp;Battery charger &nbsp; , AA batteries inlcuded for remote&nbsp;<br>2. Change to built in rechargeable &nbsp;battery &nbsp;(12.8V Li-Ion , battery capacity same as original) , and &nbsp;charged by a Micro USB cable &nbsp;, AA batteries inlcuded for remote.&nbsp;"
			}
		],
		"astm_f963" : "T",
		"prop65_lead" : "F",
		"prop65_ph" : "T",
		"prop65_cad" : "T",
		"prop65_bpa" : "T",
		"cpsia" : "T",
		"washington_cspa" : "F",
		"tpch" : "T",
		"ul_cert" : "T",
		"colorfastness" : "T",
		"tra" : "F",
		"astm" : "F",
		"ab1109" : "T",
		"sb2860" : "T",
		"fcc" : "T",
		"cec" : "F",
		"rechargable_battery_pt" : "F",
		"usp51" : "F",
		"usp61" : "F",
		"surface_paint" : "F",
		"fda_food" : "F",
		"carb" : "F",
		"salt_spray" : "F",
		"flame_retardants" : "F",
		"flamability" : "T",
		"lacey_act" : "F",
		"bedding" : "T",
		"stuffed_article" : "F",
		"other" : "Test"
	}';

	$data = (array) json_decode($json);

	// if ($_SERVER['REQUEST_METHOD'] == 'POST')
	// {
	//     $data = json_decode(file_get_contents("php://input"), true);
	// }
	// else
	//     return;

	// ===================== Start ========================
	set_time_limit(3000);

	require_once dirname(__FILE__) . '/Classes/PHPExcel/IOFactory.php';

	$folder_name = "Quote-".round(microtime(true) * 1000);
	mkdir(dirname(__FILE__).'/log/'.$folder_name, 0777);

	$objReader = PHPExcel_IOFactory::createReader('Excel2007');
	$objPHPExcel = $objReader->load("temp.xlsx");

	$objPHPExcel->setActiveSheetIndex(0)
		->setCellValue('L1', $data['date_created'])
		->setCellValue('L2', $data['date_revised'])
		->setCellValue('L3', $data['qty'])
		->setCellValue('A5', $data['product_name'])
		->setCellValue('D5', $data['product_manager'])
		->setCellValue('A8', $data['age_grading'])
		->setCellValue('D8', $data['acc_executive'])
		->setCellValue('A11', $data['maker'])
		->setCellValue('D11', $data['factory'])
		->setCellValue('A18', $data['product_req'])
		->setCellValue('C22', $data['power_source'])
		->setCellValue('C23', $data['ac_dc_adapter'])
		->setCellValue('C24', $data['voltage'])
		->setCellValue('C25', $data['mortor_type'])
		->setCellValue('C26', $data['lumens'])
		->setCellValue('C27', $data['ansi_distance'])
		->setCellValue('C28', $data['additional_spec'])
		->setCellValue('G22', $data['frequency'])
		->setCellValue('G23', $data['working_current'])
		->setCellValue('G24', $data['standby_current'])
		->setCellValue('G25', $data['battery_life'])
		->setCellValue('G26', $data['ipx4'])
		->setCellValue('G27', $data['water_resistence'])
		->setCellValue('K22', $data['infrared'])
		->setCellValue('K23', $data['bluetooth'])
		->setCellValue('K24', $data['usb'])
		->setCellValue('K25', $data['software_included'])
		->setCellValue('K26', $data['ansi_fl1'])
		->setCellValue('C30', $data['org_pckg'])
		->setCellValue('C31', $data['org_dimensions'])
		->setCellValue('C32', $data['org_colors'])
		->setCellValue('C33', $data['org_material'])
		->setCellValue('G30', $data['new_pckg'])
		->setCellValue('G31', $data['new_dimensions'])
		->setCellValue('G32', $data['new_colors'])
		->setCellValue('G33', $data['new_material'])
		->setCellValue('L30', $data['master_cspec'])
		->setCellValue('L31', $data['master_dimensions'])
		->setCellValue('L32', $data['master_nweight'])
		->setCellValue('L33', $data['master_gweight'])
		->setCellValue('L34', $data['case_pack'])
		->setCellValue('L35', $data['country_dest'])
		->setCellValue('A40', ($data['astm_f963'] == 'T')?'✓':'')
		->setCellValue('A41', ($data['prop65_lead'] == 'T')?'✓':'')
		->setCellValue('A42', ($data['prop65_ph'] == 'T')?'✓':'')
		->setCellValue('A43', ($data['prop65_cad'] == 'T')?'✓':'')
		->setCellValue('A44', ($data['prop65_bpa'] == 'T')?'✓':'')
		->setCellValue('A45', ($data['cpsia'] == 'T')?'✓':'')
		->setCellValue('A46', ($data['washington_cspa'] == 'T')?'✓':'')
		->setCellValue('A47', ($data['tpch'] == 'T')?'✓':'')
		->setCellValue('A48', ($data['ul_cert'] == 'T')?'✓':'')
		->setCellValue('A49', ($data['colorfastness'] == 'T')?'✓':'')
		->setCellValue('D40', ($data['tra'] == 'T')?'✓':'')
		->setCellValue('D41', ($data['astm'] == 'T')?'✓':'')
		->setCellValue('D42', ($data['ab1109'] == 'T')?'✓':'')
		->setCellValue('D43', ($data['sb2860'] == 'T')?'✓':'')
		->setCellValue('D44', ($data['fcc'] == 'T')?'✓':'')
		->setCellValue('D45', ($data['cec'] == 'T')?'✓':'')
		->setCellValue('D46', ($data['rechargable_battery_pt'] == 'T')?'✓':'')
		->setCellValue('D47', ($data['usp51'] == 'T')?'✓':'')
		->setCellValue('D48', ($data['usp61'] == 'T')?'✓':'')
		->setCellValue('I40', ($data['surface_paint'] == 'T')?'✓':'')
		->setCellValue('I41', ($data['fda_food'] == 'T')?'✓':'')
		->setCellValue('I42', ($data['carb'] == 'T')?'✓':'')
		->setCellValue('I43', ($data['salt_spray'] == 'T')?'✓':'')
		->setCellValue('I44', ($data['flame_retardants'] == 'T')?'✓':'')
		->setCellValue('I45', ($data['flamability'] == 'T')?'✓':'')
		->setCellValue('I46', ($data['lacey_act'] == 'T')?'✓':'')
		->setCellValue('I47', ($data['bedding'] == 'T')?'✓':'')
		->setCellValue('I48', ($data['stuffed_article'] == 'T')?'✓':'')
		->setCellValue('B50', $data['other']);

	$img_list = [];
	$objDrawing = new PHPExcel_Worksheet_Drawing();
	$img = dirname(__FILE__).'/log/'.$folder_name.'/product.png';
	$url = htmlspecialchars_decode($data["main_thumb"]);
	$prod_img = @file_get_contents($url);
	if ($prod_img) {
		file_put_contents($img, file_get_contents($url));
		array_push($img_list, $img);
		$objDrawing->setPath($img);
		$objDrawing->setWidth(380);
		$objDrawing->setOffsetX(300);
		$objDrawing->setOffsetY(5);             
		$objDrawing->setCoordinates('G5');
		$objDrawing->setWorksheet($objPHPExcel->getActiveSheet());
	}
	// Product listing 1
	$product1 		= (array)$data["ticked_pckgs"];
	$product1_count = count($product1);
	$product1_row   = intval(($product1_count-1)/2);
	$product1_base 	= 16;

	if ($product1_count) {
		if ($product1_row) {
			$objPHPExcel->getActiveSheet()->insertNewRowBefore($product1_base+1, $product1_row);
		}
		for ($i = 0; $i < $product1_count; $i++) {
			$item = (array)$product1[$i];
			$row  = intval($product1_base + $i / 2);
			$objPHPExcel->getActiveSheet()
				->mergeCells('A'.$row.":C".$row)
				->mergeCells('D'.$row.":E".$row)
				->mergeCells('F'.$row.":G".$row)
				->mergeCells('I'.$row.":J".$row);
			$wizard = new PHPExcel_Helper_HTML;
			if ($i % 2 == 0) {
				$comp = $wizard->toRichTextObject($item['comp']);
				$run = $comp->createTextRun();
				$run->getFont()->setColor( new PHPExcel_Style_Color( 'FFFF0000' ) );
				$changes = $wizard->toRichTextObject($item['changes']);
				$objPHPExcel->getActiveSheet()
					->setCellValue('D'.$row, $comp)
					->setCellValue('F'.$row, $changes);

				$objDrawing = new PHPExcel_Worksheet_Drawing();
				$img = dirname(__FILE__).'/log/'.$folder_name.'/product'.$i.'.png';
				$url = htmlspecialchars_decode($item["photo"]);
				$prod_img = @file_get_contents($url);
				if ($prod_img) {
					file_put_contents($img, file_get_contents($url));
					array_push($img_list, $img);
					$objDrawing->setPath($img);
					$objDrawing->setWidth(265);
					$objDrawing->setOffsetX(5);
					$objDrawing->setOffsetY(5);             
					$objDrawing->setCoordinates('A'.$row);
					$objDrawing->setWorksheet($objPHPExcel->getActiveSheet());
				}
					
			} else {
				$comp = $wizard->toRichTextObject($item['comp']);
				$changes = $wizard->toRichTextObject($item['changes']);
				$objPHPExcel->getActiveSheet()
					->setCellValue('K'.$row, $item['comp'])
					->setCellValue('L'.$row, $item['changes']);
				$objPHPExcel->getActiveSheet()->getStyle('K'.$row, $comp)->applyFromArray($comp_style);
				$objPHPExcel->getActiveSheet()->getStyle('L'.$row, $changes)->applyFromArray($changes_style);

				$objDrawing = new PHPExcel_Worksheet_Drawing();
				$img = dirname(__FILE__).'/log/'.$folder_name.'/product1-'.$i.'.png';
				$url = htmlspecialchars_decode($item["photo"]);
				$prod_img = @file_get_contents($url);
				if ($prod_img) {
					file_put_contents($img, file_get_contents($url));
					array_push($img_list, $img); 
					$objDrawing->setPath($img);
					$objDrawing->setWidth(280);
					$objDrawing->setOffsetX(5);
					$objDrawing->setOffsetY(5);             
					$objDrawing->setCoordinates('I'.$row);
					$objDrawing->setWorksheet($objPHPExcel->getActiveSheet());
				}
			}
		}
	}

	// Product listing 2
	$product2 		= (array)$data["unticked_pckgs"];
	$product2_count = count($product2);
	$product2_row   = intval(($product2_count-1)/2);
	$product2_base 	= 37 + $product1_row;

	if ($product2_count) {
		$objPHPExcel->getActiveSheet()->insertNewRowBefore($product2_base+1, $product2_row);
		for ($i = 0; $i < $product2_count; $i++) {
			$item = (array)$product2[$i];
			$row  = intval($product2_base + $i / 2);
			$objPHPExcel->getActiveSheet()
				->mergeCells('A'.$row.":C".$row)
				->mergeCells('D'.$row.":E".$row)
				->mergeCells('F'.$row.":G".$row)
				->mergeCells('I'.$row.":J".$row);
			$wizard = new PHPExcel_Helper_HTML;
			$comp_style = array(
			    'font'  => array(
			        'bold'  => true
			    )
			);
			$changes_style = array(
			    'font'  => array(
			        'bold'  => true,
			        'color' => array('rgb' => 'FF0000'),
			    )
			);
			if ($i % 2 == 0) {
				$comp = $wizard->toRichTextObject($item['comp']);
				$changes = $wizard->toRichTextObject($item['changes']);
				$objPHPExcel->getActiveSheet()
					->setCellValue('D'.$row, $comp)
					->setCellValue('F'.$row, $changes);
				$objPHPExcel->getActiveSheet()->getStyle('D'.$row, $comp)->applyFromArray($comp_style);
				$objPHPExcel->getActiveSheet()->getStyle('F'.$row, $changes)->applyFromArray($changes_style);

				$objDrawing = new PHPExcel_Worksheet_Drawing();
				$img = dirname(__FILE__).'/log/'.$folder_name.'/product2-'.$i.'.png';
				$url = htmlspecialchars_decode($item["photo"]);
				$prod_img = @file_get_contents($url);
				if ($prod_img) {
					file_put_contents($img, file_get_contents($url));
					array_push($img_list, $img);
					$objDrawing->setPath($img);
					$objDrawing->setWidth(265);
					$objDrawing->setOffsetX(5);
					$objDrawing->setOffsetY(5);             
					$objDrawing->setCoordinates('A'.$row);
					$objDrawing->setWorksheet($objPHPExcel->getActiveSheet());
				}
					
			} else {
				$comp = $wizard->toRichTextObject($item['comp']);
				$changes = $wizard->toRichTextObject($item['changes']);
				$objPHPExcel->getActiveSheet()
					->setCellValue('K'.$row, $comp)
					->setCellValue('L'.$row, $changes);
				$objPHPExcel->getActiveSheet()->getStyle('K'.$row, $comp)->applyFromArray($comp_style);
				$objPHPExcel->getActiveSheet()->getStyle('L'.$row, $changes)->applyFromArray($changes_style);

				$objDrawing = new PHPExcel_Worksheet_Drawing();
				$img = dirname(__FILE__).'/log/'.$folder_name.'/product'.$i.'.png';
				$url = htmlspecialchars_decode($item["photo"]);
				$prod_img = @file_get_contents($url);
				if ($prod_img) {
					file_put_contents($img, file_get_contents($url));
					array_push($img_list, $img);
					$objDrawing->setPath($img);
					$objDrawing->setWidth(280);
					$objDrawing->setOffsetX(5);
					$objDrawing->setOffsetY(5);             
					$objDrawing->setCoordinates('I'.$row);
					$objDrawing->setWorksheet($objPHPExcel->getActiveSheet());
				}
			}
		}
	}

	$objPHPExcel->removeSheetByIndex(1);
	$objPHPExcel->setActiveSheetIndex(0);
	$objWriter = PHPExcel_IOFactory::createWriter($objPHPExcel, 'Excel2007');
	$objWriter->save(dirname(__FILE__).'/log/'.$folder_name.'/test.xlsx');

	foreach ($img_list as &$img) {
		unlink($img);
	}